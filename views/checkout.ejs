<!DOCTYPE html>
<html lang="en">
  <!-- molla/checkout.html  22 Nov 2019 09:55:06 GMT -->
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Molla - Bootstrap eCommerce Template</title>
    <meta name="keywords" content="HTML5 Template" />
    <meta name="description" content="Molla - Bootstrap eCommerce Template" />
    <meta name="author" content="p-themes" />
    <!-- Favicon -->
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/userassets/images/icons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/userassets/images/icons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/userassets/images/icons/favicon-16x16.png"
    />
    <link rel="manifest" href="/userassets/images/icons/site.html" />
    <link
      rel="mask-icon"
      href="/userassets/images/icons/safari-pinned-tab.svg"
      color="#666666"
    />
    <link rel="shortcut icon" href="/userassets/images/icons/favicon.ico" />
    <meta name="apple-mobile-web-app-title" content="Molla" />
    <meta name="application-name" content="Molla" />
    <meta name="msapplication-TileColor" content="#cc9966" />
    <meta
      name="msapplication-config"
      content="/userassets/images/icons/browserconfig.xml"
    />
    <meta name="theme-color" content="#ffffff" />
    <!-- Plugins CSS File -->
    <link rel="stylesheet" href="/userassets/css/bootstrap.min.css" />
    <!-- Main CSS File -->
    <link rel="stylesheet" href="/userassets/css/style.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.2/dist/sweetalert2.min.css">
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    
    
  </head>

  <body style="font-size: medium;">

    <div class="page-wrapper">
      <main class="main">
        <div
          class="page-header text-center"
          style="background-image: url('/userassets/images/page-header-bg.jpg')"
        >
          <div class="container">
            <h1 class="page-title">Checkout<span>Shop</span></h1>
          </div>
          <!-- End .container -->
        </div>
        <!-- End .page-header -->
        <nav aria-label="breadcrumb" class="breadcrumb-nav">
          <div class="container">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="/">Home</a></li>
              <li class="breadcrumb-item"><a href="#">Shop</a></li>
              <li class="breadcrumb-item active" aria-current="page">
                Checkout
              </li>
            </ol>
          </div>
          <!-- End .container -->
        </nav>
        <!-- End .breadcrumb-nav -->

        <div class="page-content">
          <div class="checkout">
            <div class="container">
              <div class="checkout-discount">
                <form action="#">
                  <input
                    type="text"
                    class="form-control"
                    required
                    id="checkout-discount-input"
                  />
                  <label for="checkout-discount-input" class="text-truncate"
                    >Have a coupon?
                    <span>Click here to enter your code</span></label
                  >
                </form>
              </div>
              <!-- End .checkout-discount -->
              <form action="#">
                <div class="row">
                  <div class="col-lg-9" style="font-size: medium;" >
                    <h2 class="checkout-title" ><b>Address</b></h2> 
                    <!-- End .checkout-title -->
                    <div class="card" >
                    
                      <div class="card-body" >
                        <% userAddress.address.forEach(data => { %>
                        <div class="form-check">
                          <input onclick="getaddress(`<%= data._id %>`)"  value="<%= data._id %>"
                            class="form-check-input"
                            type="radio"
                            name="flexRadioDefault"
                            id="flexRadioDefault1"
                          />&nbsp;
                          <label
                            class="form-check-label"
                            for="flexRadioDefault1"
                          >
                            <b class="dataname"><%= data.name %></b> <br><b> <%=
                            data.address %> , <%= data.locality %> , <%=
                            data.city %> , <%= data.state %> , <%= data.pincode
                            %> 
                        <br>
                       </b>
                  
                        
                        || <a href="/Edit_address/<%= data._id %>" style="color: rgb(0, 64, 255);"> Edit </a> || <br>
                 
                        <button type="button" onclick="confirmDelete('<%= data._id %>')" class="btn btn-outline-danger">Delete</button>

                          </label> 
                          <br>
                          <hr/>
                        </div>

                        <% }); %>

                        <style>
                          .dataname {
                            text-transform: uppercase;
                          }
                        </style>
                        <br>
                    <div class="row" style="justify-content: space-between; margin: 12px;">
                    
                        <button type="button" class="btn btn-primary mt-1 ms-6" data-toggle="modal" data-target="#addModal">Add Address </button>
                    </div>
                      </div>
                    </div>
                  </div>
                  <!-- End .col-lg-9 -->
                  <aside class="col-lg-3">
                    <div class="summary">
                      <h3 class="summary-title">Your Order</h3>
                      <!-- End .summary-title -->

                      <table class="table table-summary">
                        <thead>
                          <tr>
                            <th>Product</th>
                            <th>Total</th>
                          </tr>
                        </thead>

                        <tbody>
                            <% productorder.product.forEach(data => { %>
                          <tr>
                            <td>
                              <img src="/category_img/<%= data.product.image[0] %>" alt="Product Image" style="max-width: 130px; max-height: 100px;">
                            </td>
                            <td>  RS.  <%= data.product.price %> </td>
                          </tr>
                          <% } ); %>
                          <hr>
                          <tr class="summary-subtotal" >
                            <td>Subtotal:</td>
                            <td style="color: green;"> Rs. <%= productorder.totalamount %></td>
                          </tr>

                 
                          <!-- End .summary-subtotal -->
                          <tr>
                            <td>Shipping:</td>
                            <td>Free shipping</td>
                          </tr>
                          <tr class="summary-total">
                            <td>Total:</td>
                            <td>Rs. <%= productorder.totalamount %></td>
                          </tr>
                          <!-- End .summary-total -->
                    
                        </tbody>
                      </table>
                      <!-- End .table table-summary -->

                      <div class="accordion-summary" id="accordion-payment">

                        <div class="card">
                          <div class="card-header" id="heading-3">
                            <h2 class="card-title">
                              <input type="radio" name="PAYMENTMETHOD" onclick="getpayment('COD')" value="COD" id="">
                             Cash On Delivery
                           
                          </div>
                          <!-- End .collapse -->
                        </div>
                        <!-- End .card -->

                        <div class="card">
                          <div class="card-header" id="heading-4">
                            <h2 class="card-title">
                              <input type="radio" name="PAYMENTMETHOD" onclick="getpayment('PAYPAL')" value="PAYPAL" id="">
                              Paypal
                            </h2>
                          </div>
                          <!-- End .card-header -->
                          <div
                            id="collapse-4"
                            class="collapse"
                            aria-labelledby="heading-4"
                            data-parent="#accordion-payment"
                          >
                           
                            <!-- End .card-body -->
                          </div>
                          <!-- End .collapse -->
                        </div>
                        <!-- End .card -->
                        
                      </div>
                      <!-- End .accordion -->

                      <button id="placeOrderButton"
                       onclick="getSelectedRadio()"
                         type="button"
                              class="btn btn-outline-primary-2 btn-order btn-block">
                        <span class="btn-text">Place Order</span>
                        <span class="btn-hover-text">Proceed to Checkout</span>
                       </button>

                    </div>
                    <!-- End .summary -->
                  </aside>
                  <!-- End .col-lg-3 -->
                </div>
                <!-- End .row -->
              </form>
            </div>
            <!-- End .container -->
          </div>
          <!-- End .checkout -->
        </div>
        <!-- End .page-content -->
      </main>
      <!-- End .main -->

      <%- include('./partials/footer') %>
    </div>
    <!-- End .page-wrapper -->
    <button id="scroll-top" title="Back to Top">
      <i class="icon-arrow-up"></i>
    </button>

    <!-- Mobile Menu -->
    <div class="mobile-menu-overlay"></div>

    <div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editModalLabel">Edit Form</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">       
              <body>
                <form id="editForm" action="/checkoutAddress" method="post" onsubmit="return modalAddressvalidateForm()">
                    <div class="container mt-5">
                        <h2>Edit Form</h2>
                        <div class="form-group">
                            <label for="name">Name:</label>
                            <input type="text" class="form-control" id="name" name="name" placeholder="Enter name" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone:</label>
                            <input type="tel" class="form-control" id="phone" name="phone" placeholder="Enter phone" required>
                        </div>
                        <div class="form-group">
                            <label for="pin">Pin:</label>
                            <input type="tel" class="form-control" id="pin" name="pin" placeholder="Enter pin" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="city">City:</label>
                                <input type="text" class="form-control" id="city" name="city" placeholder="Enter city" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="state">State:</label>
                                <input type="text" class="form-control" id="state" name="state" placeholder="Enter state" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="locality">Locality:</label>
                            <input type="text" class="form-control" id="locality" name="locality" placeholder="Enter locality" required>
                        </div>
                        <div class="form-group">
                            <label for="address">Address:</label>
                            <input type="text" class="form-control" id="address" name="address" placeholder="Enter address" required>
                        </div>
                        <div class="form-group">
                            <label for="landmark">Landmark:</label>
                            <input type="text" class="form-control" id="landmark" name="landmark" placeholder="Enter landmark" required>
                        </div>
                        <div class="form-group">
                            <label for="alternative">Alternate Phone:</label>
                            <input type="tel" class="form-control" id="alternative" name="alternative" placeholder="Enter alternate phone" required>
                        </div>
            
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </form>
          </div>
          
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    <!-- End .mobil-menu-overlay -->


    <!-- End .mobile-menu-container -->

    <!-- Sign in / Register Modal -->

    <!-- End .modal -->

    <!-- Plugins JS File -->
  

    <script src="/javascripts/otp.js"></script>
    <script src="/javascripts/validation.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="/userassets/js/jquery.min.js"></script>
    <script src="/userassets/js/bootstrap.bundle.min.js"></script>
    <script src="/userassets/js/jquery.hoverIntent.min.js"></script>
    <script src="/userassets/js/jquery.waypoints.min.js"></script>
    <script src="/userassets/js/superfish.min.js"></script>
    <script src="/userassets/js/owl.carousel.min.js"></script>

    <!-- Main JS File -->
    <script src="/userassets/js/main.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>
      let addressid = '';
      function getaddress(id){
          addressid = id;
      }
  
      let paymentmethod = '';
      function getpayment(id){
          paymentmethod = id;
      }
  
      function getSelectedRadio() {
          const selectedValue = addressid;
          const PAYMENTMETHOD = paymentmethod;
  
          Swal.fire({
              title: "Confirm Order",
              text: "Are you sure you want to place this order?",
              icon: "warning",
              showCancelButton: true,
              confirmButtonColor: "#3085d6",
              cancelButtonColor: "#d33",
              confirmButtonText: "Yes, place the order!"
          }).then((result) => {
              if (result.isConfirmed) {
                  fetch('/checkout', {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ addressId: selectedValue, payment: PAYMENTMETHOD })
                  })
                  .then((response) => response.json())
                  .then((data) => {

                    console.log( data);

                      if (PAYMENTMETHOD === 'PAYPAL') {
                          const AMOUNT_IN_PESA = data.order.amount;
                          const options = {
                            key:data.key_id,
                              amount: AMOUNT_IN_PESA, 
                              currency: 'INR',
                              name: 'SUPER KICKS ', 
                              description: 'Payment for Order',
                              order_id:data.order.id,
                              handler: function (response){
                                console.log(response)
                                alert(response.razorpay_order_id);
                                alert(response.razorpay_signature)

                                fetch('/verify_Payment', {
                                  method: 'POST',
                                   headers: { "Content-Type": "application/json" },
                                      body: JSON.stringify({
                                  payment_OrderId: response.razorpay_order_id,
                                  payment_Signature: response.razorpay_signature,
                                  payment_Id: response.razorpay_payment_id,
                                   })
                                     })

                                     .then((response) => response.json())
                                     .then((orderDetails)=>{

                                  console.log(orderDetails);
                                  
                                  Swal.fire("Payment Successful", "Your payment was successful.", "success");
                                
                                  window.location.href = '/orderplaced/' + orderDetails;
                                }) },
                              prefill: {
                                
                                  name: 'Customer Name',
                                  email: 'customer@example.com',
                                  contact: 'Customer Contact Number'
                              },
                              theme: {
                                  color: '#3399cc' 
                              }
                          };
  
                          const razorpayInstance = new Razorpay(options);
                          razorpayInstance.open();
                      } else {
                         
                          Swal.fire("Order Placed!", "Your COD order has been placed successfully.", "success");
                          window.location.href = '/orderplaced/' + data;
                      }
                  })
                  .catch((error) => {
                      console.error("Error placing order:", error);
                      Swal.fire("Error", "There was an error placing your order. Please try again.", "error");
                  });
              }
          });
      }
  </script>
  
    
  </body>

  <!-- molla/checkout.html  22 Nov 2019 09:55:06 GMT -->
</html>
